<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>

  <style>
    /* Reset and Base Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start; /* Changed to allow scrolling for long content */
      padding: 40px 20px;
      color: #ffffff;
      overflow-y: auto; 
    }

    /* Video Background */
    #bg-video {
      position: fixed;
      top: 50%;
      left: 50%;
      min-width: 100%;
      min-height: 100%;
      width: auto;
      height: auto;
      z-index: -2;
      transform: translateX(-50%) translateY(-50%);
      object-fit: cover; 
    }

    /* Dark Overlay for Readability */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75); 
      z-index: -1;
    }

    /* Modern Glassmorphism Container */
    .glass-container {
      background: rgba(20, 20, 20, 0.4);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      padding: 40px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    .header-text {
      text-align: center;
    }

    h2 {
      margin-bottom: 5px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    h3 {
      font-size: 1.1rem;
      margin: 30px 0 15px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 8px;
      letter-spacing: 1px;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #bbbbbb;
      margin-bottom: 30px;
      display: block;
      letter-spacing: 1px;
    }

    /* Form Inputs */
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 25px;
    }

    /* Target all input types including the new date and select */
    input, textarea, select {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #ffffff;
      font-size: 15px;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-family: inherit;
      color-scheme: dark; /* Helps native date picker icons match dark mode */
    }

    select option {
      background: #222;
      color: #fff;
    }

    input::placeholder, textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #ffffff;
      background: rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* Modern Button */
    button {
      width: 100%;
      padding: 15px;
      background: #ffffff;
      color: #000000;
      border: none;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
      border-radius: 8px;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    button:hover {
      background: #e0e0e0;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
    }

    /* Payment History Cards */
    #paymentList {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .history-card {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      font-size: 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .history-card span {
      display: flex;
      justify-content: space-between;
    }

    .status-badge {
      text-transform: uppercase;
      font-size: 0.8rem;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 4px;
    }

    /* -------- EDIT MODAL -------- */
#editModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
  z-index: 999;
}

.modal-box {
  background: rgba(20,20,20,0.95);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 15px;
  padding: 30px;
  width: 100%;
  max-width: 420px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.6);
}

.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

  </style>
</head>

<body>

<video autoplay muted loop playsinline id="bg-video">
  <source src="https://www.w3schools.com/howto/rain.mp4" type="video/mp4">
</video>
<div class="overlay"></div>

<div class="glass-container">
  
  <div class="header-text">
    <h2>Kendrick Artists</h2>
    <span class="subtitle">Admin Dashboard</span>

    <!-- EDIT PAYMENT MODAL -->
<div id="editModal">
  <div class="modal-box">
    <h3>Edit Payment</h3>

    <div class="input-group">
      <input type="date" id="editDate">
      <input type="number" id="editMaintenance" placeholder="Maintenance (₹)">
      <input type="number" id="editExtras" placeholder="Extras (₹)">
      
     <select id="editStatus">
  <option value="incoming">Incoming</option>
  <option value="pending">Pending</option>
  <option value="paid">Paid</option>
  <option value="failed">Failed</option>
</select>
    </div>

    <div class="modal-actions">
      <button onclick="updatePayment()" style="flex:1;">Update</button>
      <button onclick="closeModal()" style="flex:1; background:#444; color:white;">
        Cancel
      </button>
    </div>
  </div>
</div>
  </div>

  <div class="input-group">
    <input type="number" id="maintenance" placeholder="Monthly Maintenance (₹)">
    <input type="number" id="extras" placeholder="Extras (₹)">
    <textarea id="description" placeholder="Project / Invoice Description"></textarea>
    <input type="url" id="paymentLink" placeholder="Payment Link (e.g., Payoneer)">
    <button onclick="saveData()">Save Main Record</button>
  </div>

  <h3>Add Payment to Tracker</h3>
  <div class="input-group">
    <input type="date" id="pDate">
    <input type="number" id="pMaintenance" placeholder="Maintenance Amount (₹)">
    <input type="number" id="pExtras" placeholder="Extras Amount (₹)">
    
    <select id="pStatus">
      <option value="incoming">Incoming</option>
      <option value="paid">Paid</option>
      <option value="failed">Failed</option>
    </select>
    
    <button onclick="addPayment()">Log Payment</button>
  </div>

  <h3>Payment History</h3>
  <div id="paymentList">
    </div>

</div>

<script type="module">
import { 
  db, 
  auth, 
  doc, 
  setDoc, 
  collection, 
  addDoc, 
  getDocs,
  deleteDoc,
  updateDoc,
  getDoc
} from "./firebase.js";

import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";


// ---------------- AUTH CHECK ----------------
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html";
  }
});


// ---------------- SAVE MAIN RECORD ----------------
async function saveData() {

  const maintenance = document.getElementById("maintenance").value;
  const extras = document.getElementById("extras").value;
  const description = document.getElementById("description").value;
  const paymentLink = document.getElementById("paymentLink").value;

  if (!maintenance || !description) {
    alert("Please fill maintenance and description");
    return;
  }

  try {

    await setDoc(doc(db, "clients", "client1"), {
      maintenance: Number(maintenance),
      extras: Number(extras),
      description,
      paymentLink
    });

    alert("Main record saved");

  } catch (error) {
    console.error(error);
    alert("Error saving data");
  }
}


// ---------------- ADD PAYMENT ----------------
async function addPayment() {

  const date = document.getElementById("pDate").value;
  const maintenance = Number(document.getElementById("pMaintenance").value);
  const extras = Number(document.getElementById("pExtras").value);
  const status = document.getElementById("pStatus").value;

  if (!date) {
    alert("Please select date");
    return;
  }

  const total = maintenance + extras;

  try {

    await addDoc(collection(db, "clients", "client1", "payments"), {
      date,
      maintenance,
      extras,
      total,
      status
    });

    document.getElementById("pMaintenance").value = "";
    document.getElementById("pExtras").value = "";
    document.getElementById("pDate").value = "";

    loadPayments();

  } catch (error) {
    console.error(error);
    alert("Error logging payment");
  }
}


// ---------------- LOAD PAYMENTS ----------------
async function loadPayments() {

  const list = document.getElementById("paymentList");
  list.innerHTML = "Loading history...";

  try {

    const querySnapshot = await getDocs(
      collection(db, "clients", "client1", "payments")
    );

    list.innerHTML = "";

    if (querySnapshot.empty) {
      list.innerHTML = "<p style='color:#aaa;'>No payments recorded yet.</p>";
      return;
    }

    querySnapshot.forEach((docSnap) => {

      const data = docSnap.data();
      const id = docSnap.id;

      let badgeColor = "#ffffff";
      if (data.status === "paid") badgeColor = "#4CAF50";
if (data.status === "incoming") badgeColor = "#03A9F4";   // blue for incoming
if (data.status === "pending") badgeColor = "#FFC107";    // yellow for pending
if (data.status === "failed") badgeColor = "#F44336";

      list.innerHTML += `
        <div class="history-card">
          <span><strong>Date:</strong> ${data.date}</span>
          <span><strong>Maintenance:</strong> ₹${data.maintenance}</span>
          <span><strong>Extras:</strong> ₹${data.extras}</span>
          <span><strong>Total:</strong> ₹${data.total}</span>
          <span>
            <strong>Status:</strong>
            <span class="status-badge" style="color:${badgeColor}">
              ${data.status}
            </span>
          </span>

          <div style="margin-top:10px; display:flex; gap:10px;">
            <button onclick="editPayment('${id}')" style="flex:1;">Edit</button>
            <button onclick="deletePayment('${id}')" 
              style="flex:1; background:#F44336; color:white;">
              Delete
            </button>
          </div>
        </div>
      `;
    });

  } catch (error) {
    console.error(error);
    list.innerHTML = "Failed to load history";
  }
}


// ---------------- DELETE PAYMENT ----------------
async function deletePayment(id) {

  const confirmDelete = confirm("Are you sure?");
  if (!confirmDelete) return;

  try {
    await deleteDoc(doc(db, "clients", "client1", "payments", id));
    loadPayments();
  } catch (error) {
    console.error(error);
    alert("Delete failed");
  }
}


// ---------------- PROFESSIONAL EDIT SYSTEM ----------------

let currentEditId = null;

async function editPayment(id) {

  try {

    const paymentRef = doc(db, "clients", "client1", "payments", id);
    const snapshot = await getDoc(paymentRef);

    if (!snapshot.exists()) return;

    const data = snapshot.data();

    currentEditId = id;

    document.getElementById("editDate").value = data.date;
    document.getElementById("editMaintenance").value = data.maintenance;
    document.getElementById("editExtras").value = data.extras;
    document.getElementById("editStatus").value = data.status;

    document.getElementById("editModal").style.display = "flex";

  } catch (error) {
    console.error(error);
  }
}

function closeModal() {
  document.getElementById("editModal").style.display = "none";
}

async function updatePayment() {

  const date = document.getElementById("editDate").value;
  const maintenance = Number(document.getElementById("editMaintenance").value);
  const extras = Number(document.getElementById("editExtras").value);
  const status = document.getElementById("editStatus").value;

  const total = maintenance + extras;

  try {

    await updateDoc(
      doc(db, "clients", "client1", "payments", currentEditId),
      { date, maintenance, extras, total, status }
    );

    closeModal();
    loadPayments();

  } catch (error) {
    console.error(error);
    alert("Update failed");
  }
}


// ---------------- GLOBAL ACCESS ----------------
window.saveData = saveData;
window.addPayment = addPayment;
window.deletePayment = deletePayment;
window.editPayment = editPayment;
window.updatePayment = updatePayment;
window.closeModal = closeModal;

// ---------------- INITIAL LOAD ----------------
loadPayments();

</script>
</body>
</html>